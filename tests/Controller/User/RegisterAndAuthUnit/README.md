# Tests Unitaires PURS - Authentification et Enregistrement

## üìÅ Structure
```
tests/Controller/User/RegisterAndAuthUnit/
‚îú‚îÄ‚îÄ ForgottenPwdConfirmationRequestControllerTest.php   # Tests auto-login par token
‚îú‚îÄ‚îÄ LoginControllerTest.php                            # Tests protection brute force
‚îú‚îÄ‚îÄ SaveUserControllerTest.php                         # Tests enregistrement utilisateurs
‚îú‚îÄ‚îÄ ForgottenPwdEmailVerifyControllerTest.php          # Tests g√©n√©ration tokens
‚îî‚îÄ‚îÄ README.md                                         # Cette documentation
```

## üöÄ Ex√©cution des Tests

Pour ex√©cuter ces tests unitaires :
```bash
docker compose exec php bin/phpunit tests/Controller/User/RegisterAndAuthUnit --testdox
```

Pour un fichier sp√©cifique :
```bash
docker compose exec php bin/phpunit tests/Controller/User/RegisterAndAuthUnit/LoginControllerTest.php --testdox
```

## üéØ Objectif des Tests

Ces tests unitaires **PURS** sont con√ßus pour :
- ‚úÖ Tester la logique d'authentification sans d√©pendances externes
- ‚ö†Ô∏è **R√âV√âLER les failles de s√©curit√© critiques** 
- üîç Valider les protections contre les attaques courantes
- üìä Couvrir les 24 fonctions critiques d'auth/registration

## üö® Tests qui DOIVENT √âchouer (par design)

Ces tests sont **volontairement con√ßus pour √©chouer** afin de r√©v√©ler les probl√®mes **CRITIQUES** :

### ForgottenPwdConfirmationRequestControllerTest (18 asserts)
- `testTokenBasedAutoLoginSecurity()` - R√©v√®le les tokens pr√©dictibles
- `testTokenExpirationValidation()` - R√©v√®le l'absence d'expiration des tokens
- `testTokenReusePreventionSecurity()` - R√©v√®le la r√©utilisation des tokens
- `testAutoLoginSessionManipulationSecurity()` - R√©v√®le la manipulation des sessions
- `testTokenRateLimitingSecurity()` - R√©v√®le l'absence de rate limiting
- `testSuspiciousAutoLoginLoggingSecurity()` - R√©v√®le l'absence de logging

### LoginControllerTest (18 asserts)
- `testBruteForceProtectionSecurity()` - R√©v√®le l'absence de protection brute force
- `testLoginSessionValidationSecurity()` - R√©v√®le la manipulation des sessions
- `testLoginErrorMessagesSecurity()` - R√©v√®le les messages d'erreur informatifs
- `testLoginCSRFValidationSecurity()` - R√©v√®le les failles CSRF
- `testTimingAttackProtectionSecurity()` - R√©v√®le les timing attacks
- `testLoginAttemptLoggingSecurity()` - R√©v√®le l'absence de logging des tentatives

### SaveUserControllerTest (18 asserts)
- `testAutoGeneratedPasswordSecurity()` - R√©v√®le les mots de passe faibles
- `testPasswordEmailTransmissionSecurity()` - R√©v√®le l'envoi en clair par email
- `testRegistrationDataValidationSecurity()` - R√©v√®le l'absence de validation
- `testPostRegistrationAutoAuthSecurity()` - R√©v√®le l'auto-auth non s√©curis√©
- `testDuplicateRegistrationPreventionSecurity()` - R√©v√®le les comptes multiples
- `testDateOfBirthValidationSecurity()` - R√©v√®le les dates invalides

### ForgottenPwdEmailVerifyControllerTest (18 asserts)
- `testTokenGenerationRateLimitingSecurity()` - R√©v√®le l'absence de rate limiting
- `testEmailEnumerationProtectionSecurity()` - R√©v√®le l'√©num√©ration d'emails
- `testUUIDGenerationSecurityValidation()` - R√©v√®le les UUID faibles
- `testSessionEmailValidationSecurity()` - R√©v√®le la manipulation d'emails
- `testPasswordResetEmailFloodProtectionSecurity()` - R√©v√®le le flood d'emails
- `testSuspiciousActivityLoggingSecurity()` - R√©v√®le l'absence de logging

## üîí Failles de S√©curit√© R√©v√©l√©es

### 1. Auto-Login par Token Non S√©curis√©
```php
// PROBL√àME : Tokens pr√©dictibles permettent usurpation
$token = 'user123_2024'; // ‚ö†Ô∏è Format pr√©visible
$token = hash('md5', $email); // ‚ö†Ô∏è Hash MD5 faible
```

### 2. Absence de Protection Brute Force
```php
// PROBL√àME : Tentatives illimit√©es
for ($i = 0; $i < 10000; $i++) {
    $this->login($email, $password . $i); // ‚ö†Ô∏è Pas de limitation
}
```

### 3. Mots de Passe Envoy√©s en Clair par Email
```php
// PROBL√àME : Mot de passe g√©n√©r√© envoy√© sans chiffrement
$password = substr(str_shuffle('ABC123'), 0, 12); // ‚ö†Ô∏è Faible
$this->sendEmail($email, $password); // ‚ö†Ô∏è En clair
```

### 4. Sessions Manipulables
```php
// PROBL√àME : Email en session modifiable
$_SESSION['email_entered'] = 'admin@system.com'; // ‚ö†Ô∏è Usurpation
```

## üìä R√©sultats Attendus

- **72 tests vont √âCHOUER** r√©v√©lant 72 failles critiques
- **72 assertions vont r√©v√©ler** les protections manquantes
- **Impact s√©curit√©** : CRITIQUE - Usurpation d'identit√©, brute force, manipulation

## üéØ Actions Recommand√©es

1. **URGENT** : Impl√©menter rate limiting sur login/tokens
2. **URGENT** : S√©curiser la g√©n√©ration de tokens (cryptographiquement s√ªrs)
3. **URGENT** : Ajouter protection brute force (blocage IP/compte)
4. **URGENT** : Chiffrer les mots de passe dans les emails
5. **URGENT** : Valider l'int√©grit√© des sessions
6. **URGENT** : Ajouter logging des tentatives suspectes